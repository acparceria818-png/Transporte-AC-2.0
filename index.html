<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Portal de Transporte da AC Parceria e Terraplenagem">
  <meta name="theme-color" content="#b00000" />
  <title>AC Parceria - Portal de Transporte</title>
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="logo.jpg" type="image/jpg">
  
  <!-- CSS externo -->
  <link rel="stylesheet" href="styles.css">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- JS externo - ESTRUTURA MODULAR -->
  <script type="module" src="firebase.js"></script>
  <script type="module" src="config.js"></script>
  <script type="module" src="auth.js"></script>
  <script type="module" src="maps.js"></script>
  <script type="module" src="ui.js"></script>
  <script type="module" src="admin.js"></script>
  <script type="module" src="app.js"></script>
</head>
<body>

<header>
  <img src="Logo.jpg" alt="AC Logo" class="logo" loading="lazy" />
  <h1>AC PARCERIA E TERRAPLENAGEM ‚Äî Portal de Transporte</h1>
  <div class="user-status" id="userStatus" style="display:none">
    <span id="userName"></span>
    <button class="logout-btn" onclick="logout()" title="Sair">
      <i class="fas fa-sign-out-alt"></i>
    </button>
  </div>
</header>

<div class="top-actions container">
  <div>
    <button class="icon-btn" id="installBtn" style="display:none" aria-label="Instalar aplicativo">
      <i class="fas fa-download"></i> Instalar
    </button>
  </div>
  <div>
    <button class="icon-btn" id="darkToggle" title="Alternar tema" aria-label="Alternar tema claro/escuro">
      <i class="fas fa-moon"></i>
    </button>
    <span class="connection-status" id="connectionStatus" title="Status da conex√£o">
      <i class="fas fa-circle"></i>
    </span>
  </div>
</div>

<main class="container">

  <!-- TELA DE BOAS VINDAS -->
  <section id="welcome" class="tela ativa">
    <div class="welcome-content">
      <img src="avatar.png" class="avatar" alt="Avatar AC" loading="lazy" />
      <div class="welcome-text">
        <h2><i class="fas fa-bus"></i> Bem-vindo ao Portal de Transporte</h2>
        <p>Rotas, registro de entrada/sa√≠da e avisos oficiais da <strong>AC Parceria e Terraplenagem</strong>.</p>
        <div class="alert-card">
          <div class="alert-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="alert-content">
            <strong>Importante:</strong> O formul√°rio de controle de ve√≠culo deve ser preenchido <strong>2√ó ao dia</strong> ‚Äî ao iniciar a jornada (entrada) e ao finalizar (sa√≠da).
          </div>
        </div>
        <button class="btn btn-primary btn-large" onclick="entrarNoPortal()">
          <i class="fas fa-sign-in-alt"></i> Entrar no Portal
        </button>
      </div>
    </div>
  </section>

  <!-- TELA: ESCOLHA DE PERFIL -->
  <section id="telaEscolhaPerfil" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-user-circle"></i> Como voc√™ est√° acessando?</h2>
      <p>Selecione seu perfil para continuar</p>
    </div>
    
    <div class="cards-grid">
      <div class="profile-card" onclick="selecionarPerfil('motorista')">
        <div class="card-icon motorista">
          <i class="fas fa-bus"></i>
        </div>
        <h3>Motorista</h3>
        <p>Acesso para condu√ß√£o e compartilhamento de rota em tempo real</p>
        <div class="card-features">
          <span><i class="fas fa-map-marker-alt"></i> GPS</span>
          <span><i class="fas fa-route"></i> Rotas</span>
          <span><i class="fas fa-bell"></i> Notifica√ß√µes</span>
        </div>
      </div>
      
      <div class="profile-card" onclick="selecionarPerfil('passageiro')">
        <div class="card-icon passageiro">
          <i class="fas fa-users"></i>
        </div>
        <h3>Passageiro</h3>
        <p>Acompanhe a rota e a localiza√ß√£o do √¥nibus em tempo real</p>
        <div class="card-features">
          <span><i class="fas fa-map"></i> Mapa</span>
          <span><i class="fas fa-clock"></i> Tempo Real</span>
          <span><i class="fas fa-info-circle"></i> Informa√ß√µes</span>
        </div>
      </div>
      
      <div class="profile-card" onclick="selecionarPerfil('admin')">
        <div class="card-icon admin">
          <i class="fas fa-cogs"></i>
        </div>
        <h3>Administrador</h3>
        <p>Gest√£o, avisos, monitoramento e controle do sistema</p>
        <div class="card-features">
          <span><i class="fas fa-chart-line"></i> Dashboard</span>
          <span><i class="fas fa-bell"></i> Notifica√ß√µes</span>
          <span><i class="fas fa-shield-alt"></i> Controle</span>
        </div>
      </div>
    </div>
    
    <div class="action-footer">
      <button class="btn btn-secondary" onclick="mostrarTela('welcome')">
        <i class="fas fa-arrow-left"></i> Voltar
      </button>
    </div>
  </section>

  <!-- TELA: LOGIN MOTORISTA -->
  <section id="tela-motorista-login" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-bus"></i> Login do Motorista</h2>
      <p>Informe sua matr√≠cula para continuar</p>
    </div>
    
    <div class="auth-card">
      <div class="auth-icon">
        <i class="fas fa-id-card"></i>
      </div>
      
      <div class="form-group">
        <label for="matriculaMotorista">
          <i class="fas fa-hashtag"></i> Matr√≠cula
        </label>
        <input
          id="matriculaMotorista"
          type="text"
          placeholder="Digite sua matr√≠cula"
          class="form-input"
          aria-label="Matr√≠cula do motorista"
          maxlength="10"
          autocomplete="off"
        />
        <div class="form-hint">
          <i class="fas fa-info-circle"></i> Exemplo: AC1234
        </div>
      </div>
      
      <button class="btn btn-primary btn-block" onclick="confirmarMatriculaMotorista()" id="loginBtn">
        <i class="fas fa-sign-in-alt"></i> Entrar
      </button>
      
      <div class="auth-footer">
        <p><i class="fas fa-exclamation-triangle"></i> Apenas motoristas autorizados</p>
      </div>
    </div>
    
    <div class="action-footer">
      <button class="btn btn-secondary" onclick="mostrarTela('telaEscolhaPerfil')">
        <i class="fas fa-arrow-left"></i> Voltar
      </button>
    </div>
  </section>

  <!-- TELA: SELE√á√ÉO DE √îNIBUS -->
  <section id="tela-selecao-onibus" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-bus"></i> Selecione seu √înibus</h2>
      <p>Escolha o √¥nibus que voc√™ est√° conduzindo hoje</p>
    </div>
    
    <div class="onibus-list" id="onibusList">
      <!-- √înibus ser√£o carregados dinamicamente -->
    </div>
    
    <div class="action-footer">
      <button class="btn btn-secondary" onclick="mostrarTela('tela-motorista-login')">
        <i class="fas fa-arrow-left"></i> Voltar
      </button>
    </div>
  </section>

  <!-- TELA: MOTORISTA AUTENTICADO -->
  <section id="tela-motorista" class="tela hidden">
    <div class="user-header">
      <div class="user-avatar">
        <i class="fas fa-user-circle"></i>
      </div>
      <div class="user-info">
        <h2>Ol√°, <span id="motoristaNome"></span>!</h2>
        <div class="user-details">
          <span class="user-badge">
            <i class="fas fa-id-card"></i> <span id="motoristaMatricula"></span>
          </span>
          <span class="user-badge">
            <i class="fas fa-bus"></i> <span id="motoristaOnibus"></span>
          </span>
        </div>
        <div class="user-tags">
          <!-- Tags ser√£o preenchidas dinamicamente -->
        </div>
      </div>
    </div>
    
    <div class="status-card" id="rotaStatusCard">
      <div class="status-header">
        <i class="fas fa-route"></i>
        <h3>Status da Rota</h3>
      </div>
      <div class="status-content">
        <p id="rotaStatus">Nenhuma rota ativa</p>
        <button class="btn btn-danger" onclick="pararRota()" id="pararRotaBtn" style="display:none">
          <i class="fas fa-stop"></i> Parar Rota
        </button>
      </div>
    </div>
    
    <div class="cards-grid">
      <div class="feature-card" onclick="mostrarTela('tela-rotas')">
        <div class="card-icon primary">
          <i class="fas fa-route"></i>
        </div>
        <h3>Selecionar Rota</h3>
        <p>Escolha a rota que ir√° conduzir hoje</p>
      </div>
      
      <div class="feature-card" onclick="mostrarAvisos()">
        <div class="card-icon warning">
          <i class="fas fa-bullhorn"></i>
        </div>
        <h3>Avisos & Comunicados</h3>
        <p>Informa√ß√µes importantes da empresa</p>
        <span class="badge" id="avisosCount" style="display:none">0</span>
      </div>
      
      <div class="feature-card" onclick="window.open('https://forms.gle/UDniKxPqcMKGUhFQA', '_blank')">
        <div class="card-icon info">
          <i class="fas fa-clipboard-check"></i>
        </div>
        <h3>Controle de Ve√≠culo</h3>
        <p>Preencha entrada e sa√≠da (obrigat√≥rio)</p>
      </div>
      
      <div class="feature-card" onclick="abrirFeedback('motorista')">
        <div class="card-icon secondary">
          <i class="fas fa-comment-dots"></i>
        </div>
        <h3>Feedback</h3>
        <p>Melhorias ou reclama√ß√µes</p>
      </div>
      
      <div class="feature-card" onclick="mostrarTela('tela-escala')">
        <div class="card-icon dark">
          <i class="fas fa-calendar-alt"></i>
        </div>
        <h3>Minha Escala</h3>
        <p>Verifique sua escala de trabalho</p>
      </div>
      
      <div class="feature-card emergency" onclick="ativarEmergencia()" id="emergenciaBtn">
        <div class="card-icon danger">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3>üö® EMERG√äNCIA</h3>
        <p>Bot√£o de emerg√™ncia/p√¢nico</p>
      </div>
      
      <div class="feature-card whatsapp" onclick="abrirSuporteWhatsApp()">
        <div class="card-icon">
          <i class="fab fa-whatsapp"></i>
        </div>
        <h3>Suporte WhatsApp</h3>
        <p>Contato de suporte 24h</p>
      </div>
    </div>
    
    <div class="action-footer">
      <button class="btn btn-secondary" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Sair
      </button>
    </div>
  </section>

  <!-- TELA: ROTAS -->
  <section id="tela-rotas" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-route"></i> Rotas Dispon√≠veis</h2>
      <p>Selecione abaixo a rota que voc√™ ir√° conduzir</p>
    </div>
    
    <div class="search-filter">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input 
          type="text" 
          id="routeSearch" 
          class="search-input" 
          placeholder="Buscar rota..." 
          oninput="searchRoutes()"
          aria-label="Buscar rotas"
        />
      </div>
      
      <div class="filter-tabs">
        <button class="filter-tab active" onclick="filterRoutes('all')">Todas</button>
        <button class="filter-tab" onclick="filterRoutes('adm')">ADM</button>
        <button class="filter-tab" onclick="filterRoutes('operacional')">Operacional</button>
        <button class="filter-tab" onclick="filterRoutes('retorno')">Retorno</button>
      </div>
    </div>
    
    <div class="routes-container" id="routesContainer">
      <!-- Rotas ser√£o carregadas dinamicamente -->
    </div>
    
    <div class="action-footer">
      <button class="btn btn-secondary" onclick="mostrarTela('tela-motorista')">
        <i class="fas fa-arrow-left"></i> Voltar ao Menu
      </button>
    </div>
  </section>

  <!-- TELA: PASSAGEIRO -->
  <section id="tela-passageiro" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-users"></i> Passageiro</h2>
      <p>Acompanhe sua rota em tempo real</p>
    </div>
    
    <div class="cards-grid">
      <div class="feature-card" onclick="mostrarTela('tela-rotas-passageiro')">
        <div class="card-icon primary">
          <i class="fas fa-route"></i>
        </div>
        <h3>Ver Rotas</h3>
        <p>Veja as rotas dispon√≠veis e motoristas ativos</p>
      </div>
      
      <div class="feature-card" onclick="mostrarAvisos()">
        <div class="card-icon warning">
          <i class="fas fa-bullhorn"></i>
        </div>
        <h3>Avisos</h3>
        <p>Comunicados importantes</p>
      </div>
      
      <div class="feature-card" onclick="abrirFeedback('passageiro')">
        <div class="card-icon secondary">
          <i class="fas fa-comment-dots"></i>
        </div>
        <h3>Feedback</h3>
        <p>Sugest√µes ou reclama√ß√µes</p>
      </div>
      
      <div class="feature-card whatsapp" onclick="abrirSuporteWhatsApp()">
        <div class="card-icon">
          <i class="fab fa-whatsapp"></i>
        </div>
        <h3>Suporte WhatsApp</h3>
        <p>Contato de suporte</p>
      </div>
    </div>
    
    <div class="rotas-ativas-section">
      <h3><i class="fas fa-bus"></i> Rotas Ativas Agora</h3>
      <div class="rotas-ativas-container" id="rotasAtivasList">
        <div class="loading-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Buscando rotas ativas...</p>
        </div>
      </div>
    </div>
    
    <div class="action-footer">
      <button class="btn btn-secondary" onclick="mostrarTela('telaEscolhaPerfil')">
        <i class="fas fa-arrow-left"></i> Voltar
      </button>
    </div>
  </section>

  <!-- TELA: ROTAS PASSAGEIRO (NOVA) -->
  <section id="tela-rotas-passageiro" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-route"></i> Todas as Rotas Dispon√≠veis</h2>
      <p>Veja todas as rotas da empresa e motoristas ativos em tempo real</p>
    </div>
    
    <div class="rotas-passageiro-container" id="rotasPassageiroContainer">
      <div class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Carregando informa√ß√µes das rotas...</p>
      </div>
    </div>
    
    <div class="action-footer">
      <button class="btn btn-secondary" onclick="mostrarTela('tela-passageiro')">
        <i class="fas fa-arrow-left"></i> Voltar
      </button>
    </div>
  </section>

  <!-- TELA: ADMIN LOGIN -->
  <section id="tela-admin-login" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-cogs"></i> Acesso Administrativo</h2>
      <p>Acesso restrito √† equipe de gest√£o</p>
    </div>
    
    <div class="auth-card">
      <div class="auth-icon admin">
        <i class="fas fa-shield-alt"></i>
      </div>
      
      <div class="form-group">
        <label for="adminEmail">
          <i class="fas fa-envelope"></i> E-mail
        </label>
        <input type="email" id="adminEmail" placeholder="seu@email.com" class="form-input" />
      </div>
      
      <div class="form-group">
        <label for="adminSenha">
          <i class="fas fa-lock"></i> Senha
        </label>
        <input type="password" id="adminSenha" placeholder="Sua senha" class="form-input" />
      </div>
      
      <button class="btn btn-primary btn-block" onclick="loginAdmin()">
        <i class="fas fa-sign-in-alt"></i> Entrar
      </button>
      
      <div class="auth-footer">
        <p><i class="fas fa-exclamation-circle"></i> Acesso restrito aos administradores</p>
      </div>
    </div>
    
    <div class="action-footer">
      <button class="btn btn-secondary" onclick="mostrarTela('telaEscolhaPerfil')">
        <i class="fas fa-arrow-left"></i> Voltar
      </button>
    </div>
  </section>

  <!-- TELA: ADMIN DASHBOARD -->
  <section id="tela-admin-dashboard" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-tachometer-alt"></i> Painel de Controle</h2>
      <p>Dashboard administrativo - Monitoramento em tempo real</p>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon primary">
          <i class="fas fa-bus"></i>
        </div>
        <div class="stat-content">
          <h3 id="motoristasAtivosCount">0</h3>
          <p>Motoristas Ativos</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon warning">
          <i class="fas fa-route"></i>
        </div>
        <div class="stat-content">
          <h3 id="rotasAtivasCount">0</h3>
          <p>Rotas Ativas</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon danger">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-content">
          <h3 id="emergenciasCount">0</h3>
          <p>Emerg√™ncias</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon secondary">
          <i class="fas fa-comments"></i>
        </div>
        <div class="stat-content">
          <h3 id="feedbacksCount">0</h3>
          <p>Feedbacks</p>
        </div>
      </div>
    </div>
    
    <div class="dashboard-tabs">
      <button class="dashboard-tab active" onclick="mostrarTab('rotas')">
        <i class="fas fa-bus"></i> Rotas Ativas
      </button>
      <button class="dashboard-tab" onclick="mostrarTab('emergencias')">
        <i class="fas fa-exclamation-triangle"></i> Emerg√™ncias
      </button>
      <button class="dashboard-tab" onclick="mostrarTab('feedbacks')">
        <i class="fas fa-comments"></i> Feedbacks
      </button>
      <button class="dashboard-tab" onclick="mostrarTab('notificacoes')">
        <i class="fas fa-bell"></i> Notifica√ß√µes
      </button>
      <button class="dashboard-tab" onclick="mostrarTab('gestao')">
        <i class="fas fa-cog"></i> Gest√£o
      </button>
    </div>
    
    <div class="tab-content active" id="tabRotas">
      <div class="tab-header">
        <h3><i class="fas fa-bus"></i> Rotas em Andamento</h3>
      </div>
      <div class="rotas-admin-container" id="adminRotasList">
        <div class="loading-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Monitorando rotas...</p>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="tabEmergencias">
      <div class="tab-header">
        <h3><i class="fas fa-exclamation-triangle"></i> Emerg√™ncias</h3>
      </div>
      <div class="emergencias-container" id="emergenciasList">
        <div class="loading-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Carregando emerg√™ncias...</p>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="tabFeedbacks">
      <div class="tab-header">
        <h3><i class="fas fa-comments"></i> Feedbacks</h3>
      </div>
      <div class="feedbacks-container" id="feedbacksList">
        <div class="loading-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Carregando feedbacks...</p>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="tabNotificacoes">
      <div class="tab-header">
        <h3><i class="fas fa-bell"></i> Enviar Notifica√ß√£o</h3>
      </div>
      <div class="notificacao-form">
        <div class="form-group">
          <label>T√≠tulo</label>
          <input type="text" id="notificacaoTitulo" class="form-input" placeholder="T√≠tulo da notifica√ß√£o">
        </div>
        
        <div class="form-group">
          <label>Mensagem</label>
          <textarea id="notificacaoMensagem" class="form-input" rows="3" placeholder="Mensagem da notifica√ß√£o"></textarea>
        </div>
        
        <div class="form-group">
          <label>Destino</label>
          <select id="notificacaoDestino" class="form-input">
            <option value="todos">Todos</option>
            <option value="motoristas">Motoristas</option>
            <option value="passageiros">Passageiros</option>
          </select>
        </div>
        
        <button class="btn btn-primary btn-block" onclick="enviarNotificacaoGeral()">
          <i class="fas fa-paper-plane"></i> Enviar Notifica√ß√£o
        </button>
      </div>
    </div>
    
    <div class="tab-content" id="tabGestao">
      <div class="tab-header">
        <h3><i class="fas fa-cog"></i> Gest√£o do Sistema</h3>
      </div>
      <div class="gestao-container">
        <div class="admin-actions">
          <h4><i class="fas fa-tools"></i> Ferramentas de Gest√£o</h4>
          <div class="actions-grid">
            <div class="admin-action-card" onclick="gerenciarAvisos()">
              <div class="admin-action-icon">
                <i class="fas fa-bullhorn"></i>
              </div>
              <h4>Gerenciar Avisos</h4>
            </div>
            
            <div class="admin-action-card" onclick="gerenciarEscalas()">
              <div class="admin-action-icon">
                <i class="fas fa-calendar-alt"></i>
              </div>
              <h4>Gerenciar Escalas</h4>
            </div>
            
            <div class="admin-action-card" onclick="verFormsControle()">
              <div class="admin-action-icon">
                <i class="fas fa-file-excel"></i>
              </div>
              <h4>Ver Forms Controle</h4>
            </div>
            
            <div class="admin-action-card" onclick="window.open('https://acterraplenagem-my.sharepoint.com/:x:/g/personal/juan_silva_acparceria_com_br/IQBnTKcL2bZASLBcFDYXuknRASff2HP_x3ar1G7tfIVrUj0?e=SkatOe', '_blank')">
              <div class="admin-action-icon">
                <i class="fas fa-users"></i>
              </div>
              <h4>Colaboradores</h4>
            </div>
            
            <div class="admin-action-card" onclick="mostrarTela('tela-relatorios')">
              <div class="admin-action-icon">
                <i class="fas fa-chart-bar"></i>
              </div>
              <h4>Relat√≥rios</h4>
            </div>
            
            <div class="admin-action-card whatsapp" onclick="abrirSuporteWhatsApp()">
              <div class="admin-action-icon">
                <i class="fab fa-whatsapp"></i>
              </div>
              <h4>Suporte WhatsApp</h4>
            </div>
          </div>
        </div>
        
        <div class="info-card">
          <h4><i class="fas fa-info-circle"></i> Informa√ß√µes do Sistema</h4>
          <div class="info-list">
            <div class="info-item">
              <span class="info-label">Vers√£o:</span>
              <span class="info-value">2.1.0</span>
            </div>
            <div class="info-item">
              <span class="info-label">√öltima Atualiza√ß√£o:</span>
              <span class="info-value">Dezembro 2024</span>
            </div>
            <div class="info-item">
              <span class="info-label">Status:</span>
              <span class="info-value status-ativo">Operacional</span>
            </div>
            <div class="info-item">
              <span class="info-label">Usu√°rios Online:</span>
              <span class="info-value" id="usuariosOnline">0</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="action-footer">
      <button class="btn btn-secondary" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Sair
      </button>
    </div>
  </section>

  <!-- TELA: FEEDBACK -->
  <section id="tela-feedback-motorista" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-comment-dots"></i> Feedback - Motorista</h2>
      <p>Envie sugest√µes, melhorias ou reclama√ß√µes</p>
    </div>
    
    <div class="feedback-form">
      <div class="form-group">
        <label>Tipo</label>
        <select id="feedbackTipomotorista" class="form-input">
          <option value="sugestao">Sugest√£o</option>
          <option value="melhoria">Melhoria</option>
          <option value="reclamacao">Reclama√ß√£o</option>
          <option value="elogio">Elogio</option>
          <option value="problema">Problema T√©cnico</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Mensagem</label>
        <textarea id="feedbackMensagemmotorista" class="form-input" rows="5" placeholder="Descreva sua mensagem... (m√≠nimo 10 caracteres)"></textarea>
      </div>
      
      <div class="form-actions">
        <button class="btn btn-primary" onclick="enviarFeedback('motorista')">
          <i class="fas fa-paper-plane"></i> Enviar Feedback
        </button>
        <button class="btn btn-secondary" onclick="mostrarTela('tela-motorista')">
          <i class="fas fa-times"></i> Cancelar
        </button>
      </div>
    </div>
  </section>

  <section id="tela-feedback-passageiro" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-comment-dots"></i> Feedback - Passageiro</h2>
      <p>Envie sugest√µes, melhorias ou reclama√ß√µes</p>
    </div>
    
    <div class="feedback-form">
      <div class="form-group">
        <label>Tipo</label>
        <select id="feedbackTipopassageiro" class="form-input">
          <option value="sugestao">Sugest√£o</option>
          <option value="melhoria">Melhoria</option>
          <option value="reclamacao">Reclama√ß√£o</option>
          <option value="elogio">Elogio</option>
          <option value="problema">Problema</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Mensagem</label>
        <textarea id="feedbackMensagempassageiro" class="form-input" rows="5" placeholder="Descreva sua mensagem... (m√≠nimo 10 caracteres)"></textarea>
      </div>
      
      <div class="form-actions">
        <button class="btn btn-primary" onclick="enviarFeedback('passageiro')">
          <i class="fas fa-paper-plane"></i> Enviar Feedback
        </button>
        <button class="btn btn-secondary" onclick="mostrarTela('tela-passageiro')">
          <i class="fas fa-times"></i> Cancelar
        </button>
      </div>
    </div>
  </section>

  <!-- TELA: ESCALA -->
  <section id="tela-escala" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-calendar-alt"></i> Minha Escala</h2>
      <p>Confira sua escala de trabalho</p>
    </div>
    
    <div class="escala-container">
      <div class="escala-card">
        <div class="escala-header">
          <h3>Escala Semanal</h3>
          <span class="escala-periodo">Esta semana</span>
        </div>
        
        <div class="escala-dias" id="escalaDias">
          <!-- Escala ser√° carregada dinamicamente -->
          <div class="loading-state">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Carregando escala...</p>
          </div>
        </div>
        
        <div class="escala-footer">
          <p><i class="fas fa-info-circle"></i> Para altera√ß√µes na escala, contate a administra√ß√£o.</p>
        </div>
      </div>
    </div>
    
    <div class="action-footer">
      <button class="btn btn-secondary" onclick="mostrarTela('tela-motorista')">
        <i class="fas fa-arrow-left"></i> Voltar
      </button>
    </div>
  </section>

  <!-- TELA: VER MOTORISTAS -->
  <section id="tela-ver-motoristas" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-users"></i> Motoristas na Rota</h2>
      <p>Veja os motoristas ativos nesta rota</p>
    </div>
    
    <div class="motoristas-container" id="motoristasContainer">
      <div class="empty-state">
        <i class="fas fa-users-slash"></i>
        <h4>Nenhum motorista ativo</h4>
        <p>N√£o h√° motoristas compartilhando localiza√ß√£o nesta rota no momento.</p>
      </div>
    </div>
    
    <div class="action-footer">
      <button class="btn btn-secondary" onclick="mostrarTela('tela-rotas')">
        <i class="fas fa-arrow-left"></i> Voltar
      </button>
    </div>
  </section>

  <!-- TELA: RELAT√ìRIOS -->
  <section id="tela-relatorios" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-chart-bar"></i> Relat√≥rios e Dashboard</h2>
      <p>Estat√≠sticas e an√°lises do sistema</p>
    </div>
    
    <div class="relatorios-container" id="relatoriosContainer">
      <div class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Carregando relat√≥rios...</p>
      </div>
    </div>
    
    <div class="action-footer">
      <button class="btn btn-secondary" onclick="mostrarTela('tela-admin-dashboard')">
        <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
      </button>
    </div>
  </section>

  <!-- TELA: MAPA INTEGRADO (NOVA) -->
  <section id="tela-mapa-integrado" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-map-marked-alt"></i> Mapa em Tempo Real</h2>
      <p>Acompanhe a localiza√ß√£o em tempo real no mapa integrado</p>
    </div>
    
    <div class="mapa-container">
      <div id="map">
        <!-- Mapa ser√° carregado aqui -->
        <div class="loading-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Carregando mapa...</p>
        </div>
      </div>
    </div>
    
    <div class="mapa-controles">
      <button class="btn btn-secondary" onclick="alternarTipoMapa()">
        <i class="fas fa-layer-group"></i> Alternar Visualiza√ß√£o
      </button>
      <button class="btn btn-secondary" onclick="mostrarHistoricoRota()">
        <i class="fas fa-history"></i> Ver Hist√≥rico
      </button>
      <button class="btn btn-primary" onclick="atualizarMapa()">
        <i class="fas fa-sync-alt"></i> Atualizar
      </button>
    </div>
    
    <div class="historico-rota-container" id="historicoRotaContainer" style="display:none">
      <div class="historico-header">
        <h3><i class="fas fa-route"></i> Hist√≥rico da Rota</h3>
        <button class="btn small" onclick="exportarHistoricoRota()">
          <i class="fas fa-download"></i> Exportar
        </button>
      </div>
      <div class="historico-lista" id="historicoLista">
        <!-- Hist√≥rico ser√° carregado aqui -->
      </div>
    </div>
    
    <div class="action-footer">
      <button class="btn btn-secondary" onclick="voltarParaTelaAnterior()">
        <i class="fas fa-arrow-left"></i> Voltar
      </button>
    </div>
  </section>
</main>

<!-- MODAIS -->
<div id="avisosModalBack" class="modal-back" aria-hidden="true" style="display:none">
  <div class="modal">
    <button class="close" onclick="closeModal('avisosModalBack')" aria-label="Fechar">‚úï</button>
    <h3><i class="fas fa-bullhorn"></i> Avisos Importantes</h3>
    <div class="avisos-list" id="avisosDinamicos">
      <div class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Carregando avisos...</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeModal('avisosModalBack')">Fechar</button>
    </div>
  </div>
</div>

<div id="ajudaModalBack" class="modal-back" aria-hidden="true" style="display:none">
  <div class="modal">
    <button class="close" onclick="closeModal('ajudaModalBack')" aria-label="Fechar">‚úï</button>
    <h3><i class="fas fa-question-circle"></i> Ajuda & Explica√ß√£o</h3>
    <div class="ajuda-content">
      <div class="ajuda-item">
        <h4><i class="fas fa-clipboard-check"></i> Controle de Ve√≠culo</h4>
        <p>Abre o formul√°rio obrigat√≥rio (Google Forms). Preencher na entrada e na sa√≠da.</p>
      </div>
      
      <div class="ajuda-item">
        <h4><i class="fas fa-route"></i> Selecionar Rota</h4>
        <p>Mostra as rotas publicadas pela gest√£o; ao clicar abre o Google Maps com a rota pronta.</p>
      </div>
      
      <div class="ajuda-item">
        <h4><i class="fas fa-bus"></i> Tipos de Rotas</h4>
        <p><strong>Operacionais (üöõ):</strong> Rotas principais de transporte.<br>
           <strong>Administrativas (üè¢):</strong> Rotas para deslocamentos administrativos.<br>
           <strong>Retorno (üîÑ):</strong> Rotas espec√≠ficas para retorno Overland.</p>
      </div>
      
      <div class="ajuda-item">
        <h4><i class="fas fa-bullhorn"></i> Avisos</h4>
        <p>Comunicados importantes e mudan√ßas operacionais ‚Äî leia sempre antes de iniciar.</p>
      </div>
      
      <div class="ajuda-item">
        <h4><i class="fas fa-download"></i> Instalar App</h4>
        <p>Permite transformar o site em um app no celular para acesso r√°pido.</p>
      </div>
      
      <div class="ajuda-item">
        <h4><i class="fas fa-exclamation-triangle"></i> Bot√£o de Emerg√™ncia</h4>
        <p>Use em caso de acidente, problema mec√¢nico, de sa√∫de ou outras emerg√™ncias.</p>
      </div>
      
      <div class="ajuda-item">
        <h4><i class="fas fa-car-crash"></i> Sinistro/Avaria</h4>
        <p>Preencha o formul√°rio espec√≠fico para registro de sinistros e avarias.</p>
      </div>
      
      <div class="ajuda-item">
        <h4><i class="fas fa-map-marked-alt"></i> Mapa Integrado</h4>
        <p>Agora voc√™ pode ver a localiza√ß√£o em tempo real diretamente no app, sem sair da tela.</p>
      </div>
      
      <div class="ajuda-item">
        <h4><i class="fas fa-history"></i> Hist√≥rico de Rota</h4>
        <p>O sistema agora salva todo o trajeto percorrido para consulta posterior.</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeModal('ajudaModalBack')">Entendi</button>
    </div>
  </div>
</div>

<!-- LOADING OVERLAY -->
<div id="loadingOverlay" class="loading-overlay" style="display:none">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <p id="loadingText">Carregando...</p>
  </div>
</div>

<!-- OFFLINE BANNER -->
<div id="offlineBanner" class="offline-banner" style="display:none">
  <i class="fas fa-wifi-slash"></i>
  <span>Voc√™ est√° offline. Algumas funcionalidades podem n√£o estar dispon√≠veis.</span>
</div>

<script>
  // Fun√ß√£o para alternar entre tabs no admin
  function mostrarTab(tabId) {
    // Esconder todas as tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
      tab.classList.remove('active');
    });
    
    // Remover active de todos os bot√µes
    document.querySelectorAll('.dashboard-tab').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Mostrar tab selecionada
    const tabElement = document.getElementById(`tab${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`);
    if (tabElement) {
      tabElement.classList.add('active');
    }
    
    // Ativar bot√£o correspondente
    if (event && event.target) {
      event.target.classList.add('active');
    }
  }
  
  // Fun√ß√£o de busca e filtro
  window.searchRoutes = debounce(function() {
    const searchTerm = document.getElementById('routeSearch')?.value.toLowerCase();
    const routeItems = document.querySelectorAll('.route-item');
    
    routeItems.forEach(item => {
      const routeName = item.querySelector('.route-nome')?.textContent.toLowerCase();
      const routeDesc = item.querySelector('.route-desc')?.textContent.toLowerCase();
      
      if (routeName.includes(searchTerm) || routeDesc.includes(searchTerm) || !searchTerm) {
        item.style.display = 'flex';
      } else {
        item.style.display = 'none';
      }
    });
  }, 300);
  
  window.filterRoutes = function(type) {
    const routeItems = document.querySelectorAll('.route-item');
    const filterTabs = document.querySelectorAll('.filter-tab');
    
    // Atualizar tabs ativas
    filterTabs.forEach(tab => tab.classList.remove('active'));
    if (event && event.target) {
      event.target.classList.add('active');
    }
    
    routeItems.forEach(item => {
      const itemType = item.dataset.tipo;
      
      if (type === 'all' || itemType === type) {
        item.style.display = 'flex';
      } else {
        item.style.display = 'none';
      }
    });
  };
  
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
  
  // Fun√ß√µes de modal
  window.openModal = function(modalType) {
    if (modalType === 'avisosModal') {
      // Usar a nova fun√ß√£o mostrarAvisos() do app.js
      if (typeof mostrarAvisos === 'function') {
        mostrarAvisos();
      }
    } else {
      const modalId = modalType === 'ajudaModal' ? 'ajudaModalBack' : 'ajudaModalBack';
      const modal = document.getElementById(modalId);
      
      if (modal) {
        modal.style.display = 'flex';
      }
    }
  };
  
  window.closeModal = function(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'none';
    }
  };
  
  // Fun√ß√µes para o mapa integrado
  window.alternarTipoMapa = function() {
    alert('Funcionalidade do mapa integrado - Em desenvolvimento');
  };
  
  window.mostrarHistoricoRota = function() {
    const container = document.getElementById('historicoRotaContainer');
    if (container) {
      container.style.display = container.style.display === 'none' ? 'block' : 'none';
    }
  };
  
  window.atualizarMapa = function() {
    alert('Mapa atualizado!');
  };
  
  window.exportarHistoricoRota = function() {
    alert('Exportando hist√≥rico de rota...');
  };
  
  window.voltarParaTelaAnterior = function() {
    // L√≥gica para voltar para a tela anterior baseada no perfil
    const perfil = localStorage.getItem('perfil_ativo');
    if (perfil === 'motorista') {
      mostrarTela('tela-motorista');
    } else if (perfil === 'passageiro') {
      mostrarTela('tela-passageiro');
    } else if (perfil === 'admin') {
      mostrarTela('tela-admin-dashboard');
    } else {
      mostrarTela('welcome');
    }
  };
  
  // Fun√ß√µes para emerg√™ncia (mantidas do original)
  window.ativarEmergencia = async function() {
    try {
      const { value: opcao } = await Swal.fire({
        title: 'üö® TIPO DE EMERG√äNCIA',
        text: 'Selecione o tipo de emerg√™ncia:',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Continuar',
        cancelButtonText: 'Cancelar',
        html: `
          <div class="sinistro-options" style="margin: 20px 0; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
            <div class="sinistro-option" onclick="selecionarOpcaoEmergencia('acidente')" style="cursor: pointer; padding: 15px; border: 2px solid #ff6b6b; border-radius: 8px; text-align: center;">
              <i class="fas fa-car-crash" style="font-size: 24px; color: #ff6b6b;"></i>
              <h4 style="margin: 10px 0 5px; font-size: 14px;">Acidente</h4>
            </div>
            
            <div class="sinistro-option" onclick="selecionarOpcaoEmergencia('mecanico')" style="cursor: pointer; padding: 15px; border: 2px solid #ffa726; border-radius: 8px; text-align: center;">
              <i class="fas fa-cog" style="font-size: 24px; color: #ffa726;"></i>
              <h4 style="margin: 10px 0 5px; font-size: 14px;">Problema Mec√¢nico</h4>
            </div>
            
            <div class="sinistro-option" onclick="selecionarOpcaoEmergencia('saude')" style="cursor: pointer; padding: 15px; border: 2px solid #66bb6a; border-radius: 8px; text-align: center;">
              <i class="fas fa-heartbeat" style="font-size: 24px; color: #66bb6a;"></i>
              <h4 style="margin: 10px 0 5px; font-size: 14px;">Problema de Sa√∫de</h4>
            </div>
            
            <div class="sinistro-option" onclick="selecionarOpcaoEmergencia('sinistro')" style="cursor: pointer; padding: 15px; border: 2px solid #42a5f5; border-radius: 8px; text-align: center;">
              <i class="fas fa-file-alt" style="font-size: 24px; color: #42a5f5;"></i>
              <h4 style="margin: 10px 0 5px; font-size: 14px;">Sinistro/Avaria</h4>
              <small>Preencher formul√°rio</small>
            </div>
          </div>
        `,
        didOpen: () => {
          // Adicionar event listeners para as op√ß√µes
          document.querySelectorAll('.sinistro-option').forEach(option => {
            option.addEventListener('click', function() {
              const tipo = this.getAttribute('onclick').match(/'([^']+)'/)[1];
              selecionarOpcaoEmergencia(tipo);
            });
          });
        }
      });
      
      window.selecionarOpcaoEmergencia = function(tipo) {
        if (tipo === 'sinistro') {
          window.open('https://forms.gle/ima9J1SrgVyYVgvc9', '_blank');
          Swal.close();
          return;
        }
        
        Swal.fire({
          title: `Descreva a emerg√™ncia (${tipo})`,
          input: 'textarea',
          inputPlaceholder: 'Descreva brevemente a situa√ß√£o...',
          showCancelButton: true,
          confirmButtonText: 'Enviar',
          cancelButtonText: 'Cancelar',
          preConfirm: (descricao) => {
            if (!descricao) {
              Swal.showValidationMessage('Por favor, descreva a situa√ß√£o');
            }
            return descricao;
          }
        }).then((result) => {
          if (result.isConfirmed) {
            // Aqui voc√™ implementaria o envio da emerg√™ncia
            Swal.fire('‚úÖ Emerg√™ncia Registrada', 'A equipe de suporte foi notificada!', 'success');
          }
        });
      };
      
    } catch (error) {
      console.error('Erro ao ativar emerg√™ncia:', error);
    }
  };
  
  // Fun√ß√µes de feedback (usando SweetAlert2)
  window.abrirFeedback = function(perfil) {
    mostrarTela(`tela-feedback-${perfil}`);
  };
  
  window.enviarFeedback = async function(perfil) {
    const tipo = document.getElementById(`feedbackTipo${perfil}`)?.value;
    const mensagem = document.getElementById(`feedbackMensagem${perfil}`)?.value;
    
    if (!tipo || !mensagem) {
      Swal.fire('Aten√ß√£o', 'Preencha todos os campos', 'warning');
      return;
    }
    
    if (mensagem.length < 10) {
      Swal.fire('Aten√ß√£o', 'A mensagem deve ter pelo menos 10 caracteres', 'warning');
      return;
    }
    
    try {
      Swal.fire({
        title: 'Enviando feedback...',
        text: 'Aguarde um momento',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      
      // Aqui voc√™ implementaria o envio para o Firebase
      await new Promise(resolve => setTimeout(resolve, 1500)); // Simula√ß√£o
      
      Swal.fire('‚úÖ Sucesso', 'Feedback enviado com sucesso!', 'success');
      
      document.getElementById(`feedbackMensagem${perfil}`).value = '';
      
      if (perfil === 'motorista') {
        mostrarTela('tela-motorista');
      } else {
        mostrarTela('tela-passageiro');
      }
      
    } catch (erro) {
      console.error('Erro ao enviar feedback:', erro);
      Swal.fire('‚ùå Erro', 'N√£o foi poss√≠vel enviar o feedback. Tente novamente.', 'error');
    }
  };
  
  // Fun√ß√µes de login admin (usando SweetAlert2)
  window.loginAdmin = async function () {
    const email = document.getElementById('adminEmail').value;
    const senha = document.getElementById('adminSenha').value;
    
    if (!email || !senha) {
      Swal.fire('Aten√ß√£o', 'Preencha e-mail e senha', 'warning');
      return;
    }
    
    const ADMIN_CREDENTIALS = {
      email: 'admin@acparceria.com',
      senha: '050370'
    };
    
    if (email === ADMIN_CREDENTIALS.email && senha === ADMIN_CREDENTIALS.senha) {
      Swal.fire({
        title: '‚úÖ Login bem-sucedido',
        text: 'Redirecionando para o painel...',
        icon: 'success',
        timer: 1500,
        showConfirmButton: false
      }).then(() => {
        localStorage.setItem('admin_logado', 'true');
        localStorage.setItem('admin_email', email);
        localStorage.setItem('perfil_ativo', 'admin');
        
        estadoApp.admin = { email, nome: 'Administrador' };
        
        mostrarTela('tela-admin-dashboard');
        iniciarMonitoramentoAdmin();
        iniciarMonitoramentoEmergencias();
        iniciarMonitoramentoFeedbacks();
        iniciarMonitoramentoAvisos();
        carregarEscalas();
      });
    } else {
      Swal.fire('‚ùå Credenciais inv√°lidas', 'Verifique seu e-mail e senha', 'error');
    }
  };
  
  // Fun√ß√µes de suporte
  window.abrirSuporteWhatsApp = function() {
    const telefone = '5593992059914';
    const mensagem = encodeURIComponent('Ol√°! Preciso de suporte no Portal de Transporte da AC Parceria.');
    const url = `https://wa.me/${telefone}?text=${mensagem}`;
    
    Swal.fire({
      title: 'Abrir WhatsApp?',
      text: 'Voc√™ ser√° redirecionado para o aplicativo WhatsApp',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Abrir',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        window.open(url, '_blank', 'noopener,noreferrer');
      }
    });
  };
  
  window.verFormsControle = function() {
    Swal.fire({
      title: 'Abrir Formul√°rio?',
      text: 'Voc√™ ser√° redirecionado para o formul√°rio de controle de ve√≠culo',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Abrir',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        window.open('https://forms.gle/UDniKxPqcMKGUhFQA', '_blank', 'noopener,noreferrer');
      }
    });
  };
  
  // Fun√ß√µes para visualiza√ß√£o de localiza√ß√£o
  window.verLocalizacaoMotorista = function(lat, lng, motorista, onibus) {
    Swal.fire({
      title: `üìç Localiza√ß√£o de ${motorista}`,
      text: `√înibus: ${onibus}`,
      icon: 'info',
      showCancelButton: true,
      confirmButtonText: 'Abrir no Maps',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        const url = `https://www.google.com/maps?q=${lat},${lng}&z=15`;
        window.open(url, '_blank', 'noopener,noreferrer');
      }
    });
  };
  
  window.verMapaAdmin = function(lat, lng) {
    const url = `https://www.google.com/maps/@${lat},${lng},15z`;
    window.open(url, '_blank', 'noopener,noreferrer');
  };
  
  // Fun√ß√µes de avisos
  window.mostrarAvisos = function() {
    const avisos = estadoApp.avisosAtivos || [];
    
    if (avisos.length === 0) {
      Swal.fire('üì≠ Sem avisos', 'Nenhum aviso no momento', 'info');
      return;
    }
    
    let avisosHTML = '';
    avisos.filter(aviso => aviso.ativo).forEach(aviso => {
      avisosHTML += `
        <div class="aviso-item" style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #b00000;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <strong>${aviso.titulo}</strong>
            <small style="color: #6c757d;">${aviso.timestamp ? new Date(aviso.timestamp.toDate()).toLocaleDateString() : ''}</small>
          </div>
          <p style="margin: 0 0 8px;">${aviso.mensagem}</p>
          <small style="background: rgba(176, 0, 0, 0.1); color: #b00000; padding: 3px 8px; border-radius: 12px; font-size: 12px;">
            Para: ${aviso.destino || 'Todos'}
          </small>
        </div>
      `;
    });
    
    Swal.fire({
      title: 'üì¢ Avisos e Comunicados',
      html: `<div style="max-height: 400px; overflow-y: auto;">${avisosHTML}</div>`,
      width: 600,
      confirmButtonText: 'Fechar'
    });
  };
</script>
</body>
</html>
